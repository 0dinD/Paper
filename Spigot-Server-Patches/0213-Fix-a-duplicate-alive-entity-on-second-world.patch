From cfd888d784201ae7ec2a67352ca5747e9bae5a91 Mon Sep 17 00:00:00 2001
From: Shane Freeder <theboyetronic@gmail.com>
Date: Fri, 17 Mar 2017 01:45:15 +0000
Subject: [PATCH] Fix a duplicate alive entity on second world


diff --git a/src/main/java/net/minecraft/server/Entity.java b/src/main/java/net/minecraft/server/Entity.java
index 0e1d9817b..92ba4fcb5 100644
--- a/src/main/java/net/minecraft/server/Entity.java
+++ b/src/main/java/net/minecraft/server/Entity.java
@@ -2325,7 +2325,7 @@ public abstract class Entity implements ICommandListener {
             // CraftBukkit end */
 
             this.world.kill(this);
-            this.dead = false;
+            //this.dead = false; // Paper - Mark entity as dead before we actually move it to the new world
             this.world.methodProfiler.a("reposition");
             /* CraftBukkit start - Handled in calculateTarget
             BlockPosition blockposition;
diff --git a/src/main/java/net/minecraft/server/PlayerList.java b/src/main/java/net/minecraft/server/PlayerList.java
index a9d59bbf5..4ba4d527e 100644
--- a/src/main/java/net/minecraft/server/PlayerList.java
+++ b/src/main/java/net/minecraft/server/PlayerList.java
@@ -969,7 +969,7 @@ public abstract class PlayerList {
             d0 = (double) MathHelper.clamp((int) d0, -29999872, 29999872);
             d1 = (double) MathHelper.clamp((int) d1, -29999872, 29999872);
             */
-            if (entity.isAlive()) {
+            //if (entity.isAlive()) { // Paper - Moved down
                 // entity.setPositionRotation(d0, entity.locY, d1, entity.yaw, entity.pitch);
                 // worldserver1.getTravelAgent().a(entity, f);
                 if (portal) {
@@ -981,8 +981,8 @@ public abstract class PlayerList {
                     }
                 }
                 // worldserver1.addEntity(entity);
-                worldserver1.entityJoinedWorld(entity, false);
-            }
+                if (entity.isAlive()) worldserver1.entityJoinedWorld(entity, false); // Paper - Moved down from above
+            //} // Paper
 
             worldserver.methodProfiler.b();
         }
-- 
2.12.0.windows.1

