From 2c7c11780055e40e42eae8b6d6a5ab2f578bc92a Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Sat, 7 Jan 2017 15:24:46 -0500
Subject: [PATCH] Provide E/TE/Chunk count stat methods

Provides counts without the ineffeciency of using .getEntities().size()
which creates copy of the collections.

diff --git a/src/main/java/net/minecraft/server/WorldServer.java b/src/main/java/net/minecraft/server/WorldServer.java
index ff75bb3c6..5ed0fbe5a 100644
--- a/src/main/java/net/minecraft/server/WorldServer.java
+++ b/src/main/java/net/minecraft/server/WorldServer.java
@@ -51,7 +51,7 @@ import org.bukkit.event.weather.LightningStrikeEvent;
 public class WorldServer extends World {
 
     private static final Logger LOGGER = LogManager.getLogger();
-    private final List<Entity> globalEntityList = Lists.newArrayList();
+    public final List<Entity> globalEntityList = Lists.newArrayList(); // Paper - private -> public
     public final Int2ObjectMap<Entity> entitiesById = new Int2ObjectLinkedOpenHashMap();
     private final Map<UUID, Entity> entitiesByUUID = Maps.newHashMap();
     private final Queue<Entity> entitiesToAdd = Queues.newArrayDeque();
diff --git a/src/main/java/org/bukkit/craftbukkit/CraftWorld.java b/src/main/java/org/bukkit/craftbukkit/CraftWorld.java
index b8de76007..c79b0f42a 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftWorld.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftWorld.java
@@ -265,6 +265,35 @@ public class CraftWorld implements World {
     private int waterAnimalSpawn = -1;
     private int ambientSpawn = -1;
 
+    // Paper start - Provide fast information methods
+    // TODO review these changes
+    public int getEntityCount() {
+        return world.globalEntityList.size();
+    }
+    public int getTileEntityCount() {
+        // We don't use the full world tile entity list, so we must iterate chunks
+        Long2ObjectLinkedOpenHashMap<PlayerChunk> chunks = world.getChunkProvider().playerChunkMap.visibleChunks;
+        int size = 0;
+        for (net.minecraft.server.PlayerChunk playerchunk : chunks.values()) {
+            net.minecraft.server.Chunk chunk = playerchunk.getChunk();
+            if (chunk == null) {
+                continue;
+            }
+            size += chunk.tileEntities.size();
+        }
+        return size;
+    }
+    public int getTickableTileEntityCount() {
+        return world.tileEntityListTick.size();
+    }
+    public int getChunkCount() {
+        return world.getChunkProvider().playerChunkMap.visibleChunks.size();
+    }
+    public int getPlayerCount() {
+        return world.players.size();
+    }
+    // Paper end
+
     private static final Random rand = new Random();
 
     public CraftWorld(WorldServer world, ChunkGenerator gen, Environment env) {
-- 
2.21.0

