From 7fb729ea5b3d71930bb208d8fc8156c0bae02f1f Mon Sep 17 00:00:00 2001
From: Zach Brown <zach.brown@destroystokyo.com>
Date: Fri, 22 Apr 2016 20:34:21 -0500
Subject: [PATCH] Check entity count additions and mark entities removed


diff --git a/src/main/java/net/minecraft/server/Chunk.java b/src/main/java/net/minecraft/server/Chunk.java
index 5c1685d..137cbc6 100644
--- a/src/main/java/net/minecraft/server/Chunk.java
+++ b/src/main/java/net/minecraft/server/Chunk.java
@@ -661,6 +661,25 @@ public class Chunk {
             k = this.entitySlices.length - 1;
         }
 
+        // Paper start - Try to catch plugins doing indecent things
+        if (entity.aa) {
+            boolean thisChunk = entity.getChunkX() == this.locX && entity.getChunkY() == k && entity.getChunkZ() == this.locZ;
+            String chunkName = entity.getWorld().getWorld().getName() + ":" + entity.getChunkX() + "," + entity.getChunkY() + "," + entity.getChunkZ();
+            if (!thisChunk) {
+                throw new IllegalStateException("Entity Already in another chunk: " + chunkName);
+            } else if (this.entitySlices[k].contains(entity)) {
+                throw new IllegalStateException("Double Chunk Add to: " + chunkName);
+            } else {
+                for (int i1 = 0; i1 < this.entitySlices.length; i1++) {
+                    if (this.entitySlices[i1].contains(entity)) {
+                        throw new IllegalStateException("Entity was found in another slice of this chunk, tried: " + k + ", was in: " + chunkName);
+                    }
+                }
+                new Throwable("Improperly detected double chunk add. Was not actually in this chunk.").printStackTrace();
+            }
+        }
+        // Paper end
+
         entity.aa = true;
         entity.ab = this.locX;
         entity.ac = k;
@@ -711,6 +730,7 @@ public class Chunk {
         } else if (entity instanceof IInventory) {
             inventoryEntityCounts[i]--;
         }
+        entity.aa = false; // You aren't added to chunk anymore
         // Paper end
         // Spigot start - decrement creature type count
         // Keep this synced up with World.a(Class)
-- 
2.8.1

