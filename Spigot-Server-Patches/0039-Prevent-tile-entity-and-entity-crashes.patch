From bacdc44538b85985c04e459b6d83e2abfd62c80f Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Wed, 3 Jul 2013 08:29:26 -0400
Subject: [PATCH] Prevent tile entity and entity crashes


diff --git a/src/main/java/net/minecraft/server/TileEntity.java b/src/main/java/net/minecraft/server/TileEntity.java
index 76cdc7e..d976515 100644
--- a/src/main/java/net/minecraft/server/TileEntity.java
+++ b/src/main/java/net/minecraft/server/TileEntity.java
@@ -194,7 +194,13 @@ public abstract class TileEntity {
     public void a(CrashReportSystemDetails crashreportsystemdetails) {
         crashreportsystemdetails.a("Name", (Callable) (new CrashReportTileEntityName(this)));
         if (this.world != null) {
-            CrashReportSystemDetails.a(crashreportsystemdetails, this.position, this.w(), this.u());
+            // PaperSpigot start - Prevent tile entity and entity crashes
+            Block block = this.w();
+            if ( block != null )
+            {
+                CrashReportSystemDetails.a(crashreportsystemdetails, this.position, this.w(), this.u());
+            }
+            // PaperSpigot end
             crashreportsystemdetails.a("Actual block type", (Callable) (new CrashReportTileEntityType(this)));
             crashreportsystemdetails.a("Actual block data value", (Callable) (new CrashReportTileEntityData(this)));
         }
diff --git a/src/main/java/net/minecraft/server/World.java b/src/main/java/net/minecraft/server/World.java
index e2988a0..3ea9c92 100644
--- a/src/main/java/net/minecraft/server/World.java
+++ b/src/main/java/net/minecraft/server/World.java
@@ -1419,10 +1419,13 @@ public abstract class World implements IBlockAccess {
                     this.g(entity);
                     SpigotTimings.tickEntityTimer.stopTiming(); // Spigot
                 } catch (Throwable throwable1) {
-                    crashreport = CrashReport.a(throwable1, "Ticking entity");
-                    crashreportsystemdetails = crashreport.a("Entity being ticked");
-                    entity.appendEntityCrashDetails(crashreportsystemdetails);
-                    throw new ReportedException(crashreport);
+                    // PaperSpigot start - Prevent tile entity and entity crashes
+                    SpigotTimings.tickEntityTimer.stopTiming();
+                    System.err.println("Entity threw exception at " + entity.world.getWorld().getName() + ":" + entity.locX + "," + entity.locY + "," + entity.locZ);
+                    throwable1.printStackTrace();
+                    entity.dead = true;
+                    continue;
+                    // PaperSpigot end
                 }
             }
 
@@ -1489,11 +1492,13 @@ public abstract class World implements IBlockAccess {
                         tileentity.tickTimer.startTiming(); // Spigot
                         ((IUpdatePlayerListBox) tileentity).c();
                     } catch (Throwable throwable2) {
-                        CrashReport crashreport1 = CrashReport.a(throwable2, "Ticking block entity");
-                        CrashReportSystemDetails crashreportsystemdetails1 = crashreport1.a("Block entity being ticked");
-
-                        tileentity.a(crashreportsystemdetails1);
-                        throw new ReportedException(crashreport1);
+                        // PaperSpigot start - Prevent tile entity and entity crashes
+                        tileentity.tickTimer.stopTiming();
+                        System.err.println("TileEntity threw exception at " + tileentity.world.getWorld().getName() + ":" + tileentity.position.getX() + "," + tileentity.position.getY() + "," + tileentity.position.getZ());
+                        throwable2.printStackTrace();
+                        iterator.remove();
+                        continue;
+                        // PaperSpigot end
                     }
                     // Spigot start
                     finally {
-- 
1.9.5.msysgit.0

